name: Close inactive issues
on:
  workflow_dispatch: {}
permissions:
  issues: write
  pull-requests: write
jobs:
  close-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
    - name: Get date 30 days ago
      id: last-month
      run: echo "date=$(node .github/workflows/getPreviousMonth.js)" >> $GITHUB_OUTPUT
    - name: Get inactive issues and close them
      env:
        GH_TOKEN: ${{ github.token }}
      run: "# Get the date from previous step\nCUTOFF_DATE=\"${{ steps.last-month.outputs.date\
        \ }}\"\necho \"Looking for issues updated before: $CUTOFF_DATE\"\n\n# Get\
        \ all issues updated before the cutoff date\nISSUE_LIST=$(gh issue list --limit\
        \ 100 --search \"updated:<$CUTOFF_DATE\" --json number,title,updatedAt --jq\
        \ '.[] | \"\\(.number) \\(.title)\"')\n\nif [ -z \"$ISSUE_LIST\" ]; then\n\
        \  echo \"No inactive issues found\"\n  exit 0\nfi\n\necho \"Found inactive\
        \ issues:\"\necho \"$ISSUE_LIST\"\n\n# Process each issue\ngh issue list --limit\
        \ 100 --search \"updated:<$CUTOFF_DATE\" --json number --jq '.[].number' |\
        \ while read issue_number; do\n  if [ ! -z \"$issue_number\" ]; then\n   \
        \ echo \"Processing issue #$issue_number\"\n\n    ISSUE_LABELS=$(gh issue\
        \ view $issue_number --json labels --jq '.labels[].name' | tr '\\n' ' ')\n\
        \    if [[ \"$ISSUE_LABELS\" =~ (^| )triage-needed( |$) ]]; then\n      echo\
        \ \"Issue #$issue_number has triage-needed label, skipping\"\n      continue\n\
        \    fi\n\n    # Close the issue\n    gh issue close $issue_number --comment\
        \ \"Due to lack of details for further investigation, we will archive the\
        \ issue for now. In case you still have following-up questions on this issue,\
        \ please always feel free to reopen the issue by clicking 'reopen issue' button\
        \ below the comment box. We will get back to you as soon as possible.\"\n\
        \    \n    echo \"Closed issue #$issue_number\"\n  fi\ndone\n"
    - name: Triage active issues
      env:
        GH_TOKEN: ${{ github.token }}
        REPO_OWNERS: ${{ vars.REPO_OWNERS || '' }}
      run: "echo \"Checking active issues for triage...\"\n\n# Get all open issues\n\
        gh issue list --state open --json number,title | jq -r '.[] | .number' | while\
        \ read issue_number; do\n  if [ ! -z \"$issue_number\" ]; then\n    echo \"\
        Checking issue #$issue_number\"\n    \n    # Get the last comment for this\
        \ issue\n    LAST_COMMENT=$(gh issue view $issue_number --json comments --jq\
        \ '.comments | if length > 0 then .[-1].author.login else empty end')\n  \
        \  \n    # If there are no comments, check the issue author\n    if [ -z \"\
        $LAST_COMMENT\" ]; then\n      LAST_COMMENT=$(gh issue view $issue_number\
        \ --json author --jq '.author.login')\n    fi\n    \n    echo \"Last comment/interaction\
        \ by: $LAST_COMMENT\"\n    \n    SHOULD_TRIAGE=true\n    if [ -n \"${REPO_OWNERS:-}\"\
        \ ]; then\n      for owner in $(echo \"$REPO_OWNERS\" | tr ',;' ' '); do\n\
        \        owner_trimmed=$(echo \"$owner\" | xargs)\n        if [ \"$LAST_COMMENT\"\
        \ = \"$owner_trimmed\" ]; then\n          SHOULD_TRIAGE=false\n          break\n\
        \        fi\n      done\n    fi\n\n    if [ \"$SHOULD_TRIAGE\" = true ] &&\
        \ [ ! -z \"$LAST_COMMENT\" ]; then\n      echo \"Issue #$issue_number needs\
        \ triage (last interaction by $LAST_COMMENT)\"\n      \n      # Get current\
        \ labels\n      CURRENT_LABELS=$(gh issue view $issue_number --json labels\
        \ --jq '.labels[].name' | tr '\\n' ' ')\n      echo \"Current labels: $CURRENT_LABELS\"\
        \n      \n      # Add triage-needed label only when investigating/triage-needed\
        \ are absent\n      if [[ \"$CURRENT_LABELS\" =~ (^| )investigating( |$) ]];\
        \ then\n        echo \"Issue #$issue_number is under investigation, skipping\
        \ triage label\"\n      elif [[ \"$CURRENT_LABELS\" =~ (^| )triage-needed(\
        \ |$) ]]; then\n        echo \"Issue #$issue_number already has triage-needed\
        \ label, skipping\"\n      else\n        echo \"Adding triage-needed label\
        \ to issue #$issue_number\"\n        gh issue edit $issue_number --repo ${{\
        \ github.repository }} --add-label \"triage-needed\"\n      fi\n      \n \
        \     # Remove info-needed label if present\n      if [[ \"$CURRENT_LABELS\"\
        \ =~ (^| )info-needed( |$) ]]; then\n        echo \"Removing info-needed label\
        \ from issue #$issue_number\"\n        gh issue edit $issue_number --repo\
        \ ${{ github.repository }} --remove-label \"info-needed\"\n      fi\n    else\n\
        \      if [ -z \"$LAST_COMMENT\" ]; then\n        echo \"Issue #$issue_number\
        \ has no interaction to evaluate, skipping\"\n      else\n        echo \"\
        Issue #$issue_number last interaction by repository owner ($LAST_COMMENT),\
        \ skipping\"\n      fi\n    fi\n  fi\ndone\n\necho \"Triage check completed\""
